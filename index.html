<!doctype html>
<html lang="en" data-bs-theme="auto">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Drill Library — Auto Excel Loader (Resilient)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root { --touch-target: 48px; }
    body { -webkit-font-smoothing: antialiased; }
    .container { max-width: 720px; }
    .accordion-button { padding-top: .9rem; padding-bottom: .9rem; min-height: var(--touch-target); }
    .accordion-button span.drill-name { flex: 1; font-weight: 600; letter-spacing: .2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .accordion-item { border-radius: 16px; overflow: hidden; border: 1px solid var(--bs-border-color); }
    .accordion-item + .accordion-item { margin-top: .75rem; }
    .accordion-body { padding: .85rem; }
    .page { padding: 1rem .75rem 2.5rem; }
    @media (min-width: 576px) { .page { padding: 1.25rem; } }
    .badge-soft { background: var(--bs-secondary-bg); color: var(--bs-secondary-color); }
    .status-box { padding: .75rem; border: 1px dashed var(--bs-border-color); border-radius: .75rem; }
    .status-box.error { border-color: var(--bs-danger-border-subtle, #f5c2c7); color: var(--bs-danger-text-emphasis, #842029); background: var(--bs-danger-bg-subtle, #f8d7da); }
    .uploader input { display: none; }
    .uploader { display: none; } /* hidden by default; shown only on error */ 
    /* Collapsible subsection buttons */
    .subtoggle { width: 100%; text-align: left; padding: .6rem .75rem; border-radius: .65rem; border: 1px solid var(--bs-border-color); background: transparent; }
    .subtoggle[aria-expanded="true"] { background: var(--bs-secondary-bg); }
    .subtoggle .caret { transition: transform .2s ease; }
    .subtoggle[aria-expanded="true"] .caret { transform: rotate(90deg); }
    .subsection { margin-bottom: .5rem; }
    .subsection .collapse { padding: .5rem .15rem 0 .15rem; }
  </style>
</head>
<body>
  <main class="page container">
    <header class="mb-3 d-flex align-items-center justify-content-between gap-2">
      <div>
        <h1 class="h4 mb-1">Drills</h1>
        <p class="text-secondary small mb-0"></p>
      </div>
      <label class="btn btn-sm btn-outline-secondary uploader" id="uploaderLbl">
        <input id="xlsxFile" type="file" accept=".xlsx,.xlsm,.xls" />
        Load Excel
      </label>
    </header>

    <div id="status" class="status-box small">Loading <code>SoccerDrillsList.xlsx</code>…</div>

    <div class="accordion mt-2" id="drillsAccordion"></div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    // Theme
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');
    const applyTheme = () => document.documentElement.setAttribute('data-bs-theme', prefersDark.matches ? 'dark' : 'light');
    prefersDark.addEventListener('change', applyTheme);
    applyTheme();

    // Allow override via ?file=YourFile.xlsx
    const params = new URLSearchParams(location.search);
    const EXCEL_PATH = params.get('file') || "SoccerDrillsList.xlsx"; 

    const NORMALIZE = s => (s || '').toString().trim();
    const SPLITLIST = v => NORMALIZE(v)
      .split(/;|\n|\r|•\s*|–\s*|—\s*|^-\s*/)
      .map(x => x.replace(/^[-•–—]\s*/, '').trim())
      .filter(Boolean);

    function ytembed(url) {
      url = NORMALIZE(url);
      if (!url) return "";
      try {
        const u = new URL(url);
        if (u.hostname.includes('youtube.com')) {
          if (u.pathname === '/watch') return `https://www.youtube.com/embed/${u.searchParams.get('v')}`;
          const parts = u.pathname.split('/').filter(Boolean);
          if (parts[0] === 'shorts' && parts[1]) return `https://www.youtube.com/embed/${parts[1]}`;
          if (parts[0] === 'embed' && parts[1]) return url;
        }
        if (u.hostname === 'youtu.be') return `https://www.youtube.com/embed/${u.pathname.slice(1)}`;
      } catch(e) {}
      return url;
    }

    function mapColumns(headers) {
      const idx = {};
      headers.forEach((h, i) => {
        const key = h.toLowerCase().replace(/\s+/g, ' ').replace(/\s*\/\s*/g, ' / ').trim();
        idx[key] = i;
      });
      const find = name => {
        const key = name.toLowerCase().replace(/\s+/g, ' ').replace(/\s*\/\s*/g, ' / ').trim();
        return idx[key] ?? -1;
      };
      return { find };
    }

    function section(title, innerHTML, collapseId) {
      if (!innerHTML) return '';
      return `
        <div class="subsection">
          <button class="subtoggle d-flex align-items-center justify-content-between" type="button"
                  data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false" aria-controls="${collapseId}">
            <span>${title}</span>
            <span class="caret">▶</span>
          </button>
          <div id="${collapseId}" class="collapse">
            <div class="pt-2 px-1">${innerHTML}</div>
          </div>
        </div>`;
    }

    function renderDrills(drills) {
      const acc = document.getElementById('drillsAccordion');
      acc.innerHTML = '';
      drills.forEach((d, idx) => {
        const id = `drill${idx}`;
        const videoSrc = ytembed(d.video_url || '');

        const setupUl = (d.setup || []).map(s => `<li>${s}</li>`).join('');
        const cpUl = (d.coaching_points || []).map(s => `<li>${s}</li>`).join('');
        const progUl = (d.progression || []).map(s => `<li>${s}</li>`).join('');
        const areaUl = (d.area_setup || []).map(s => `<li>${s}</li>`).join('');

        const metaRow = [];
        if (d.players) metaRow.push(`<span class="badge rounded-pill badge-soft">${d.players}</span>`);
        if (d.objective) metaRow.push(`<span class="badge rounded-pill badge-soft">${d.objective}</span>`);

        const item = document.createElement('div');
        item.className = 'accordion-item';
        item.innerHTML = `
          <h2 class="accordion-header" id="heading-${id}">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${id}" aria-expanded="false" aria-controls="collapse-${id}">
              <span class="drill-name">${(d.nr ? d.nr + ') ' : '') + (d.name || 'Untitled drill')}</span>
            </button>
          </h2>
          <div id="collapse-${id}" class="accordion-collapse collapse" aria-labelledby="heading-${id}" data-bs-parent="#drillsAccordion">
            <div class="accordion-body">
              ${videoSrc ? `<div class="ratio ratio-16x9 rounded overflow-hidden mb-2"><iframe src="${videoSrc}" title="${d.name || 'Drill video'}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>` : ''}
              ${metaRow.length ? `<div class="d-flex flex-wrap gap-2 mb-2">${metaRow.join('')}</div>` : ''}

              ${section('Objective / Skill', d.overview ? `<p class="mb-2">${d.overview}</p>` : '', `obj-${id}`)}
              ${section('Description', (d.setup && d.setup.length) ? `<ul class="mb-2">${setupUl}</ul>` : '', `desc-${id}`)}
              ${section('Area / Setup', (d.area_setup && d.area_setup.length) ? `<ul class="mb-2">${areaUl}</ul>` : '', `area-${id}`)}
              ${section('Coaching Points', (d.coaching_points && d.coaching_points.length) ? `<ul class="mb-2">${cpUl}</ul>` : '', `cp-${id}`)}
              ${section('Progression / Variation', (d.progression && d.progression.length) ? `<ul class="mb-0">${progUl}</ul>` : '', `prog-${id}`)}
            </div>
          </div>`;
        acc.appendChild(item);
      });

      const status = document.getElementById('status');
      status.textContent = `Loaded ${drills.length} drills from ${EXCEL_PATH}`;
      setTimeout(() => status.classList.add('visually-hidden'), 1400);
    }

    function parseSheetToDrills(ws) {
      const rows = XLSX.utils.sheet_to_json(ws, { header: 1, raw: false });
      if (!rows.length) return [];
      const headers = rows[0].map(h => (h || '').toString().trim());
      const { find } = mapColumns(headers);
      const mapIdx = {
        nr: find('Nr'),
        name: find('Name'),
        desc: find('Description/Set up'),
        cp: find('Coaching points'),
        video: find('Video Link'),
        area: find('Area / Setup'),
        obj: find('Objective / Skill'),
        players: find('Players'),
        prog: find('Progression / Variation')
      };
      const drills = [];
      for (let r = 1; r < rows.length; r++) {
        const row = rows[r] || [];
        const get = (i) => (i >= 0 ? (row[i] != null ? row[i].toString() : '') : '');
        const d = {
          nr: get(mapIdx.nr).trim(),
          name: get(mapIdx.name).trim(),
          overview: get(mapIdx.obj).trim(),
          players: get(mapIdx.players).trim(),
          video_url: get(mapIdx.video).trim(),
          setup: SPLITLIST(get(mapIdx.desc)),
          area_setup: SPLITLIST(get(mapIdx.area)),
          coaching_points: SPLITLIST(get(mapIdx.cp)),
          progression: SPLITLIST(get(mapIdx.prog))
        };
        if (d.name || d.video_url || d.overview || d.coaching_points.length || d.setup.length) drills.push(d);
      }
      return drills;
    }

    async function fetchExcelAndRender() {
      const status = document.getElementById('status');
      try {
        if (location.protocol === 'file:') {
          // Many browsers block fetch() for local files due to CORS; inform user explicitly
          status.innerHTML = 'Opening over <code>file://</code>. Some browsers block reading sibling files. Trying anyway…';
        }
        const res = await fetch(EXCEL_PATH, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const buf = await res.arrayBuffer();
        const wb = XLSX.read(buf, { type: 'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const drills = parseSheetToDrills(ws);
        if (!drills.length) throw new Error('No drills found in the first sheet.');
        renderDrills(drills);
      } catch (err) {
        console.error(err);
        const status = document.getElementById('status');
        status.classList.add('error');
        status.innerHTML = \`Couldn't auto-load <code>\${EXCEL_PATH}</code> (\${err && err.message ? err.message : 'unknown error'}).<br>
          <small>\${
            (location.protocol === 'file:' 
              ? 'Tip: Start a local server in this folder: <code>python -m http.server</code> and open <code>http://localhost:8000/</code>, or use the fallback below.'
              : 'Ensure the Excel file is in the same folder on the server, or use the fallback below.'
            )
          }</small>\`;
        // Reveal fallback uploader
        document.getElementById('uploaderLbl').style.display = 'inline-flex';
      }
    }

    // Fallback: manual local file picker (only shown on error)
    document.getElementById('xlsxFile').addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const status = document.getElementById('status');
      status.classList.remove('error');
      status.textContent = 'Reading Excel…';
      try {
        const data = await file.arrayBuffer();
        const wb = XLSX.read(data, { type: 'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const drills = parseSheetToDrills(ws);
        if (!drills.length) throw new Error('No drills found');
        renderDrills(drills);
      } catch (err) {
        console.error(err);
        status.classList.add('error');
        status.textContent = 'Error parsing Excel. Check column names.';
      }
    });

    fetchExcelAndRender();
  </script>
</body>
</html>
